})
df_weight <- data.frame(grid   = weight_grid,
weight = unlist(weight_res))
qplot(grid, weight, data = df_weight, geom = "line", main= "SAM Weight") +
xlab('Sample mean from control trial')+ ylab('Weight') +
geom_vline(xintercept = summary(map_automix)['mean'], linetype = 2, col = 'blue')
weight_grid <- seq(-2, 2, by = 0.2)
weight_res  <- lapply(weight_grid, function(x){
res <- c()
for(s in 1:300){
data.control <- rnorm(n = 35, mean = x, sd = sigma)
res <- c(res, SAM_weight(if.prior = map_automix,
delta = 0.5 * sigma,
data = data.control))
}
mean(res)
})
df_weight <- data.frame(grid   = weight_grid,
weight = unlist(weight_res))
qplot(grid, weight, data = df_weight, geom = "line", main= "SAM Weight") +
xlab('Sample mean from control trial')+ ylab('Weight') +
geom_vline(xintercept = summary(map_automix)['mean'], linetype = 2, col = 'blue')
seq(-3, 3, by = 0.3)
weight_grid <- seq(-3, 3, by = 0.3)
weight_res  <- lapply(weight_grid, function(x){
res <- c()
for(s in 1:300){
data.control <- rnorm(n = 35, mean = x, sd = sigma)
res <- c(res, SAM_weight(if.prior = map_automix,
delta = 0.5 * sigma,
data = data.control))
}
mean(res)
})
df_weight <- data.frame(grid   = weight_grid,
weight = unlist(weight_res))
qplot(grid, weight, data = df_weight, geom = "line", main= "SAM Weight") +
xlab('Sample mean from control trial')+ ylab('Weight') +
geom_vline(xintercept = summary(map_automix)['mean'], linetype = 2, col = 'blue')
unit_prior <- mixnorm(nf.prior = c(1, summary(map_automix)['mean'], sigma))
SAM.prior <- SAM_prior(if.prior = map_automix,
nf.prior = unit_prior,
weight = wSAM, sigma = sigma)
SAM.prior
set.seed(123)
weak_prior <- mixnorm(c(1, summary(map_automix)[1], 1e4))
TypeI <- get_OC(if.prior = map_automix,    ## MAP prior from historical data
nf.prior = unit_prior,     ## Weak-informative prior for treatment arm
delta    = 0.5*sigma,      ## CSD for SAM prior
n        = 35, n.t = 70,   ## Sample size for control and treatment arms
## Decisions
decision = decision2S(0.95, 0, lower.tail=FALSE),
ntrial   = 1000,           ## Number of trials simulated
if.MAP   = TRUE,           ## Output robust MAP prior for comparison
weight   = 0.5,            ## Weight for robust MAP prior
## Mean for control and treatment arms
theta    = c(0, 0,   2, 4),
theta.t  = c(0, 0.1, 2, 4),
sigma    = sigma
)
kable(TypeI)
set.seed(123)
weak_prior <- mixnorm(c(1, summary(map_automix)[1], 1e4))
TypeI <- get_OC(if.prior = map_automix,    ## MAP prior from historical data
nf.prior = unit_prior,     ## Weak-informative prior for treatment arm
delta    = 0.5*sigma,      ## CSD for SAM prior
n        = 35, n.t = 70,   ## Sample size for control and treatment arms
## Decisions
decision = decision2S(0.95, 0, lower.tail=FALSE),
ntrial   = 1000,           ## Number of trials simulated
if.MAP   = TRUE,           ## Output robust MAP prior for comparison
weight   = 0.5,            ## Weight for robust MAP prior
## Mean for control and treatment arms
theta    = c(0, 0,    -2, 4),
theta.t  = c(0, -0.1, -2, 4),
sigma    = sigma
)
kable(TypeI)
set.seed(123)
Power <- get_OC(if.prior = map_automix,    ## MAP prior from historical data
nf.prior = weak_prior,     ## Non-informative prior for treatment arm
delta    = 0.5*sigma,      ## CSD for SAM prior
n        = 35, n.t = 70,   ## Sample size for control and treatment arms
## Decisions
decision = decision2S(0.95, 0, lower.tail=FALSE),
ntrial   = 1000,           ## Number of trials simulated
if.MAP   = TRUE,           ## Output robust MAP prior for comparison
weight   = 0.5,            ## Weight for robust MAP prior
## Mean for control and treatment arms
theta    = c(0, 0,  1,    -2),
theta.t  = c(1, 0.6, 1.5, -1),
sigma    = sigma
)
kable(Power)
set.seed(123)
Power <- get_OC(if.prior = map_automix,    ## MAP prior from historical data
nf.prior = weak_prior,     ## Non-informative prior for treatment arm
delta    = 0.5*sigma,      ## CSD for SAM prior
n        = 35, n.t = 70,   ## Sample size for control and treatment arms
## Decisions
decision = decision2S(0.95, 0, lower.tail=FALSE),
ntrial   = 1000,           ## Number of trials simulated
if.MAP   = TRUE,           ## Output robust MAP prior for comparison
weight   = 0.5,            ## Weight for robust MAP prior
## Mean for control and treatment arms
theta    = c(0, 0,   2, -3),
theta.t  = c(1, 0.6, 3,  -1),
sigma    = sigma
)
kable(Power)
set.seed(123)
Power <- get_OC(if.prior = map_automix,    ## MAP prior from historical data
nf.prior = weak_prior,     ## Non-informative prior for treatment arm
delta    = 0.5*sigma,      ## CSD for SAM prior
n        = 35, n.t = 70,   ## Sample size for control and treatment arms
## Decisions
decision = decision2S(0.95, 0, lower.tail=FALSE),
ntrial   = 1000,           ## Number of trials simulated
if.MAP   = TRUE,           ## Output robust MAP prior for comparison
weight   = 0.5,            ## Weight for robust MAP prior
## Mean for control and treatment arms
theta    = c(0, 0,   2,  -4),
theta.t  = c(1, 0.6, 4,  -2),
sigma    = sigma
)
kable(Power)
set.seed(123)
Power <- get_OC(if.prior = map_automix,    ## MAP prior from historical data
nf.prior = weak_prior,     ## Non-informative prior for treatment arm
delta    = 0.5*sigma,      ## CSD for SAM prior
n        = 35, n.t = 70,   ## Sample size for control and treatment arms
## Decisions
decision = decision2S(0.95, 0, lower.tail=FALSE),
ntrial   = 1000,           ## Number of trials simulated
if.MAP   = TRUE,           ## Output robust MAP prior for comparison
weight   = 0.5,            ## Weight for robust MAP prior
## Mean for control and treatment arms
theta    = c(0, 0,   2.5,  -4),
theta.t  = c(1, 0.6, 4,  -2.5),
sigma    = sigma
)
kable(Power)
set.seed(123)
Power <- get_OC(if.prior = map_automix,    ## MAP prior from historical data
nf.prior = weak_prior,     ## Non-informative prior for treatment arm
delta    = 0.5*sigma,      ## CSD for SAM prior
n        = 35, n.t = 70,   ## Sample size for control and treatment arms
## Decisions
decision = decision2S(0.95, 0, lower.tail=FALSE),
ntrial   = 1000,           ## Number of trials simulated
if.MAP   = TRUE,           ## Output robust MAP prior for comparison
weight   = 0.5,            ## Weight for robust MAP prior
## Mean for control and treatment arms
theta    = c(0, 0.1, 2.5,  -3),
theta.t  = c(1, 1.1, 4,  -1.5),
sigma    = sigma
)
kable(Power)
set.seed(123)
Power <- get_OC(if.prior = map_automix,    ## MAP prior from historical data
nf.prior = weak_prior,     ## Non-informative prior for treatment arm
delta    = 0.5*sigma,      ## CSD for SAM prior
n        = 35, n.t = 70,   ## Sample size for control and treatment arms
## Decisions
decision = decision2S(0.95, 0, lower.tail=FALSE),
ntrial   = 1000,           ## Number of trials simulated
if.MAP   = TRUE,           ## Output robust MAP prior for comparison
weight   = 0.5,            ## Weight for robust MAP prior
## Mean for control and treatment arms
theta    = c(0, 0.1, 3,  -3),
theta.t  = c(1, 1.1, 4.5,  -1.5),
sigma    = sigma
)
kable(Power)
set.seed(123)
Power <- get_OC(if.prior = map_automix,    ## MAP prior from historical data
nf.prior = weak_prior,     ## Non-informative prior for treatment arm
delta    = 0.5*sigma,      ## CSD for SAM prior
n        = 35, n.t = 70,   ## Sample size for control and treatment arms
## Decisions
decision = decision2S(0.95, 0, lower.tail=FALSE),
ntrial   = 1000,           ## Number of trials simulated
if.MAP   = TRUE,           ## Output robust MAP prior for comparison
weight   = 0.5,            ## Weight for robust MAP prior
## Mean for control and treatment arms
theta    = c(0, 0.1, 1,  -3),
theta.t  = c(1, 1.1, 2.5,  -1.5),
sigma    = sigma
)
kable(Power)
devtools::build_manual()
devtools::build_manual()
OC <- get_OC(## Informative prior constructed from historical data
if.prior = mixbeta(c(1, 30, 50)),
## Non-informative prior used for constructing the SAM prior
nf.prior = mixbeta(c(1,1,1)),
delta    = 0.2,  ## Clinically significant difference
n = 35,          ## Sample size for the control arm
n.t = 70,        ## Sample size for the treatment arm
## Decision rule to compare the whether treatment is superior
## than the control
decision = decision2S(0.95, 0, lower.tail=FALSE),ntrial   = 500,  ## Number of trials simulated
## Weight assigned to the informative component for MAP prior
weight = 0.5,
## A vector of response rate for the control arm
theta    = c(0.3, 0.36),
## A vector of response rate for the treatment arm
theta.t  = c(0.3, 0.56))
OC
prior.historical <- mixbeta(c(1, 40, 60))
data.control     <- rbinom(60, size = 1, prob = 0.42)
wSAM <- SAM_weight(if.prior = prior.historical,
delta = 0.15,        ## Clinically significant difference
data = data.control  ## Control arm data
)
wSAM
nf.prior  <- mixbeta(nf.prior = c(1,1,1))
SAM.prior <- SAM_prior(if.prior = prior.historical, ## Informative prior
plot(SAM.prior)
nf.prior = nf.prior,         ## Non-informative prior
SAM.prior <- SAM_prior(if.prior = prior.historical, nf.prior = nf.prior, weight = wSAM)
plot(SAM.prior)
sigma      <- 3
prior.mean <- 0
prior.se   <- sigma/sqrt(100)
prior.historical <- mixnorm(c(1, prior.mean, prior.se), sigma = sigma)
prior.historical
data.control <- rnorm(80, mean = 0, sd = sigma)
wSAM <- SAM_weight(if.prior = prior.historical,
delta = 0.2 * sigma,    ## Clinically significant difference
data = data.control     ## Control arm data
)
wSAM
nf.prior         <- mixnorm(nf.prior = c(1,prior.mean, sigma),
sigma = sigma)
SAM.prior <- SAM_prior(if.prior = prior.historical, ## Informative prior
plot(SAM.prior)
SAM_weight
SAM.prior <- SAM_prior(if.prior = prior.historical, nf.prior = nf.prior, weight = wSAM)
plot(SAM.prior)
prior.historical <- mixbeta(c(1, 40, 60))
wSAM <- SAM_weight(if.prior = prior.historical,
delta = 0.15,        ## Clinically significant difference
data = data.control  ## Control arm data
)
data.control     <- rbinom(60, size = 1, prob = 0.42)
wSAM <- SAM_weight(if.prior = prior.historical,
delta = 0.15,        ## Clinically significant difference
data = data.control  ## Control arm data
)
wSAm
wSAM
wSAM <- SAM_weight(if.prior = prior.historical,
delta = 0.15,    ## Clinically significant difference
print(wSAM)
## Methods to determine mixture prior for the SAM priors
## by Posterior Probability Ratio
method.w = 'PPR',
wSAM <- SAM_weight(if.prior = prior.historical,
delta = 0.15, method.w = 'PPR',prior.odd = 1/9,
n = 60,          ## Number of patients in the control arm
r = 12           ## Number of responses in the control arm
)
wSAM
wSAM <- SAM_weight(if.prior = prior.historical,
delta = 0.15, ## Clinically significant difference
n = 60, ## Number of patients in the control arm r =12 ## Number of responses in the control arm )
wSAM
aefaf
wSAM
wSAM <- SAM_weight(if.prior = prior.historical,
+                    delta = 0.15, ## Clinically significant difference
wSAM <- SAM_weight(if.prior = prior.historical,
delta = 0.15, ## Clinically significant difference
n = 60, ## Number of patients in the control arm ,r =12)
afeaf
afe
a
wSAM <- SAM_weight(if.prior = prior.historical,
delta = 0.15, ## Clinically significant difference
n = 60, r = 12)
wSAM
T_hi <- rexp(100, rate = 1)
C_hi <- runif(100, min = 0.5, max = 5)
delta_hi <- as.numeric(T_hi < C_hi)
U_hi     <- T_hi
U_hi[delta_hi == 0] <- C_hi[delta_hi == 0]
prior.historical <- mixgamma(c(1, sum(delta_hi), sum(U_hi)),
param = 'ab', likelihood = 'exp')
T_ci <- rexp(100, rate = 0.95)
C_ci <- runif(100, min = 0.5, max = 5)
delta_ci <- as.numeric(T_ci < C_ci)
U_ci     <- T_ci
U_ci[delta_ci == 0] <- C_ci[delta_ci == 0]
data.control     <- rbind(sum(delta_ci), sum(U_ci))
wSAM <- SAM_weight(if.prior = prior.historical,
delta = 0.2,            ## Clinically significant difference
data = data.control     ## Control arm data
)
prior.historical
data.control
wSAM <- SAM_weight(if.prior = prior.historical,
delta = 0.2,            ## Clinically significant difference
data = data.control     ## Control arm data
)
wSAM
?SAM_weight
if.prior = prior.historical
delta = 0.2
data = data.control
u <- sum(data[1,])
w <- sum(data[2,])
u
w
if(missing(theta.h)){
message("Using the posterior mean from informative prior as the estimate of the treatment effect based on historical data.")
theta.h <- summary(if.prior)['mean']
}
theta.h <- summary(if.prior)['mean']
method.w = 'LRT'
## The posterior mean estimation from the MAP prior
theta_h_hat <- theta.h
## The posterior mean estimation from the MAP prior
hazard_h_hat <- summary(if.prior)[theta.h]
hazard_h_hat
## The posterior mean estimation from the MAP prior
hazard_h_hat <- theta.h
## Calculate the weight for SAM prior
R <- max(dgamma(hazard_h_hat + delta, shape = u + 1, rate = w),
dgamma(hazard_h_hat - delta, shape = u + 1, rate = w))
R <- R / dgamma(hazard_h_hat, shape = u + 1, rate = w)
R
## SAM weight
w = 1 / (1 + R)
w
library(SAMprior)
?SAM_weight
devtools::build_manual()
set.seed(123)
Power <- get_OC(if.prior = map_automix,       ## MAP prior from historical data
nf.prior = mixbeta(c(1,1,1)), ## Non-informative prior for treatment arm
delta    = 0.2,               ## CSD for SAM prior
n        = 35, n.t = 70,      ## Sample size for control and treatment arms
## Decisions
decision = decision2S(0.95, 0, lower.tail=FALSE),
ntrial   = 1000,              ## Number of trials simulated
if.MAP   = TRUE,           ## Output robust MAP prior for comparison
weight   = 0.5,               ## Weight for robust MAP prior
## Response rates for control and treatment arms
theta    = c(0.37, 0.34, 0.16, 0.11),
theta.t  = c(0.57, 0.54, 0.36, 0.31)
)
set.seed(123)
std <- function(x) sd(x)/sqrt(length(x))
df_1 <- rnorm(40, 0, 3);
df_2 <- rnorm(50, 0, 3);
df_3 <- rnorm(60, 0, 3);
dat <- data.frame(study = c(1,2,3),
n = c(40, 50, 60),
mean = round(c(mean(df_1), mean(df_2), mean(df_3)), 3),
se = round(c(std(df_1), std(df_2), std(df_3)), 3))
kable(dat)
sigma = 3
# load R packages
library(ggplot2)
theme_set(theme_bw()) # sets up plotting theme
set.seed(22)
map_mcmc <- gMAP(cbind(mean, se) ~ 1 | study,
weights=n,data=dat,
family=gaussian,
beta.prior=cbind(0, sigma),
tau.dist="HalfNormal",tau.prior=cbind(0,sigma/2))
map_automix <- automixfit(map_mcmc)
map_automix
plot(map_automix)$mix
set.seed(234)
sigma        <- 3 ## Standard deviation in the current trial
data.crt     <- rnorm(30, mean = 0.4, sd = sigma)
wSAM <- SAM_weight(if.prior = map_automix,
delta = 0.5 * sigma,
data = data.crt)
cat('SAM weight: ', wSAM)
wSAM <- SAM_weight(if.prior = map_automix,
delta = 0.5 * sigma,
method.w = 'PPR',
prior.odds = 3/7,
data = data.crt)
cat('SAM weight: ', wSAM)
set.seed(123)
weak_prior <- mixnorm(c(1, summary(map_automix)[1], 1e4))
TypeI <- get_OC(if.prior = map_automix,    ## MAP prior from historical data
nf.prior = unit_prior,     ## Weak-informative prior for treatment arm
delta    = 0.5*sigma,      ## CSD for SAM prior
n        = 35, n.t = 70,   ## Sample size for control and treatment arms
## Decisions
decision = decision2S(0.95, 0, lower.tail=FALSE),
ntrial   = 1000,           ## Number of trials simulated
if.MAP   = TRUE,           ## Output robust MAP prior for comparison
weight   = 0.5,            ## Weight for robust MAP prior
## Mean for control and treatment arms
theta    = c(0, 0,    -2, 4),
theta.t  = c(0, -0.1, -2, 4),
sigma    = sigma
)
set.seed(123)
# weak_prior <- mixnorm(c(1, summary(map_automix)[1], 1e4))
TypeI <- get_OC(if.prior = map_automix,    ## MAP prior from historical data
nf.prior = unit_prior,     ## Weak-informative prior for treatment arm
delta    = 0.5*sigma,      ## CSD for SAM prior
n        = 35, n.t = 70,   ## Sample size for control and treatment arms
## Decisions
decision = decision2S(0.95, 0, lower.tail=FALSE),
ntrial   = 1000,           ## Number of trials simulated
if.MAP   = TRUE,           ## Output robust MAP prior for comparison
weight   = 0.5,            ## Weight for robust MAP prior
## Mean for control and treatment arms
theta    = c(0, 0,    -2, 4),
theta.t  = c(0, -0.1, -2, 4),
sigma    = sigma
)
unit_prior <- mixnorm(nf.prior = c(1, summary(map_automix)['mean'], sigma))
SAM.prior <- SAM_prior(if.prior = map_automix,
nf.prior = unit_prior,
weight = wSAM, sigma = sigma)
SAM.prior
set.seed(123)
# weak_prior <- mixnorm(c(1, summary(map_automix)[1], 1e4))
TypeI <- get_OC(if.prior = map_automix,    ## MAP prior from historical data
nf.prior = unit_prior,     ## Weak-informative prior for treatment arm
delta    = 0.5*sigma,      ## CSD for SAM prior
n        = 35, n.t = 70,   ## Sample size for control and treatment arms
## Decisions
decision = decision2S(0.95, 0, lower.tail=FALSE),
ntrial   = 1000,           ## Number of trials simulated
if.MAP   = TRUE,           ## Output robust MAP prior for comparison
weight   = 0.5,            ## Weight for robust MAP prior
## Mean for control and treatment arms
theta    = c(0, 0,    -2, 4),
theta.t  = c(0, -0.1, -2, 4),
sigma    = sigma
)
kable(TypeI)
set.seed(123)
Power <- get_OC(if.prior = map_automix,    ## MAP prior based on historical data
nf.prior = weak_prior,     ## Non-informative prior for treatment arm
delta    = 0.5*sigma,      ## CSD for SAM prior
n        = 35, n.t = 70,   ## Sample size for control and treatment arms
## Decisions
decision = decision2S(0.95, 0, lower.tail=FALSE),
ntrial   = 1000,           ## Number of trials simulated
if.MAP   = TRUE,           ## Output robust MAP prior for comparison
weight   = 0.5,            ## Weight for robust MAP prior
## Mean for control and treatment arms
theta    = c(0, 0.1, 1,  -3),
theta.t  = c(1, 1.1, 2.5,  -1.5),
sigma    = sigma
)
kable(Power)
set.seed(123)
Power <- get_OC(if.prior = map_automix,    ## MAP prior based on historical data
nf.prior = unit_prior,     ## Non-informative prior for treatment arm
delta    = 0.5*sigma,      ## CSD for SAM prior
n        = 35, n.t = 70,   ## Sample size for control and treatment arms
## Decisions
decision = decision2S(0.95, 0, lower.tail=FALSE),
ntrial   = 1000,           ## Number of trials simulated
if.MAP   = TRUE,           ## Output robust MAP prior for comparison
weight   = 0.5,            ## Weight for robust MAP prior
## Mean for control and treatment arms
theta    = c(0, 0.1, 1,  -3),
theta.t  = c(1, 1.1, 2.5,  -1.5),
sigma    = sigma
)
kable(Power)
set.seed(123)
Power <- get_OC(if.prior = map_automix,    ## MAP prior based on historical data
nf.prior = unit_prior,     ## Non-informative prior for treatment arm
delta    = 0.5*sigma,      ## CSD for SAM prior
n        = 35, n.t = 70,   ## Sample size for control and treatment arms
## Decisions
decision = decision2S(0.95, 0, lower.tail=FALSE),
ntrial   = 1000,           ## Number of trials simulated
if.MAP   = TRUE,           ## Output robust MAP prior for comparison
weight   = 0.5,            ## Weight for robust MAP prior
## Mean for control and treatment arms
theta    = c(0, 0.1, 0.5,  -3),
theta.t  = c(1, 1.1, 2.0,  -1.5),
sigma    = sigma
)
kable(Power)
data.crt
length(data.crt)
## Simulate data for treatment arm
data.trt <- rnorm(60, mean = 3, sd = sigma)
## first obtain posterior distributions...
post_SAM <- postmix(priormix = SAM.prior,   ## SAM Prior
data = data.crt)
post_trt <- postmix(priormix = unit_prior,  ## Non-informative prior
data = data.trt)
## Define the decision function
decision = decision2S(0.95, 0, lower.tail=FALSE)
## Decision-making
decision(post_trt, post_SAM)
library(SAMprior)
?get_OC
?SAM_prior
?SAM_weight
library(SAMprior)
?SAM_weight
library(SAMprior)
?SAM_weight
devtools::build_manual()
